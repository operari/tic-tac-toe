"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),App=function(){function e(){_classCallCheck(this,e),this.fieldSize=9,this.run="computer",this.tickType={human:"cross",computer:"nil"},this.axissDefault={},this.axiss={},this.axissValues={},this.field={},this.count=0,this.__proto__.CssClasses_={field:"tttoe",cell:"tttoe__cell",win:"tttoe__cell--winner"},this.__proto__.CssIds_={app:"app"}}return _createClass(e,[{key:"init",value:function(){var e=this;return this.countAxiss().doMatrix(this.fieldSize),this.makeField(),new Promise(function(t,n){e.makeView().then(function(e){return t()})})}},{key:"makeField",value:function(){for(var e=0;e<this.fieldSize;e++)this.field[e]={ticked:!1,tickType:"",index:e+1};this.field.length=this.fieldSize}},{key:"countAxiss",value:function(){var e=this;return{doCells:function(e){for(var t=[],n=1;n<=e;n++)t.push(n);return t},doMatrix:function(t){for(var n=this,i=["x","y","z"],r=this.doCells(t),u=Math.sqrt(t),o=function(t){var o=n.pushCells(r,u,i[t]);e.axissDefault[i[t]]=o;var s=n.pushCells(r,u,i[t]);n.computeCells(s),e.axiss[i[t]]=s.reduce(function(e,t){return e.concat(t)});var l=n.pushCells(r,u,i[t]);e.axissValues[i[t]]=n.sumAxissRows(l),n.computeCells(l,!1),e.axissValues[i[t]].forEach(function(e,t){return e[Object.keys(e)[0]]=l[t]})},s=0;s<i.length;s++)o(s)},pushCells:function(e,t,n){function i(n,r,u){r=r||[],n=n,u=u;for(var o=1;o<=e.length;o++)o%t===1&&u.push(o+(r.length?n--:n++));return r.push(u),1===r.length?i(t-1,r,[]):r}var r=[],u=[];if("z"===n)return i(0,r,u);"y"===n&&(e=e.slice(0).sort(function(e,n){return e%t-n%t}));for(var o=1;o<=e.length;o++)u.push(e[o-1]),o%t||(r.push(u),u=[]);return r},computeCells:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];e.forEach(function(e,n,i){var r=[];!function u(e){e.reduce(function(e,n,i,o){return o.length>1&&r.push(t?e*n:e+n),n===o[o.length-1]&&(o.shift(),u(o)),e})}(e),i[n]=r})},sumAxissRows:function(e){return e.map(function(e){var t=e.reduce(function(e,t){return e+t}),n={};return n[t]=[],n})}}}},{key:"makeView",value:function(){for(var e=this,t=document.createElement("table"),n=Math.sqrt(this.fieldSize),i=0;i<n;i++){for(var r=document.createElement("tr"),u=0;u<n;u++){var o=document.createElement("td");o.className=this.CssClasses_.cell,o.id=n*i+u,r.appendChild(o)}t.appendChild(r)}return t.className=this.CssClasses_.field,new Promise(function(n,i){document.addEventListener("DOMContentLoaded",function(i){e.fieldElement=document.getElementById(e.CssIds_.app),e.fieldElement.appendChild(t),n()})})}},{key:"view",value:function(e,t){this.fieldElement.querySelectorAll("td")[e].textContent="cross"===t?"x":"0"}},{key:"getRandomInt",value:function(e,t){return Math.floor(Math.random()*(t-e))+e}},{key:"winner",value:function(e,t){for(var n=0;n<e.length;n++)this.fieldElement.querySelectorAll("td")[e[n]-1].classList.add(this.CssClasses_.win+"-"+t);console.log("Winner is: "+this.run),window.location.reload()}},{key:"draw",value:function(){this.count===this.fieldSize&&window.location.reload()}},{key:"checkWinnerCombination",value:function(e,t){function n(e){for(var t=function(t){var n=e[t],i=!1;if(r.length===n.length?i=r.every(function(e){return n.some(function(t){return e===t})}):r.length>n.length&&(i=n.every(function(e){return r.some(function(t){return e===t})})),i)return{v:n}},n=0;n<e.length;n++){var i=t(n);if("object"===("undefined"==typeof i?"undefined":_typeof(i)))return i.v}return!1}var i=this,r=Array.from(this.field).filter(function(e){return e.ticked&&e.tickType===i.tickType[t]}).map(function(e){return e.index});if(e){var u=this.axissDefault[e];return n(u)}var o=[],s=[];for(var l in this.axissDefault){var a=this.axissDefault[l];s.push(n(a)),o.push(l)}var c=s.findIndex(function(e){return e.length});if(~c)return{comb:s[c],axis:"z"===o[c]&&s[c].some(function(e){return 3===e})?o[c]+"-45":o[c]}}},{key:"analysis",value:function(){var e=this;return{"do":function(){return this.filterCells()},filterCells:function(){var t=Array.from(e.field),n=t.filter(function(e){return!e.ticked}),i=t.filter(function(t){return t.tickType===e.tickType.human}),r=t.filter(function(t){return t.tickType===e.tickType.computer}),u=this.makePotentialCells(n,r,"computer"),o=0;if(!u.length&&u.cell)return u;var s=this.makePotentialCells(n,i,"human");return s.length||u.length?o=s.length?u.length?this.chooseRandomCell(u):-1:s.cell:n[0]&&n[0].index},chooseRandomCell:function(t){t=t.reduce(function(e,t){return e.concat(t)}).sort(function(e,t){return e-t});var n=[];t.length>1?t.reduce(function(e,t,i,r){return e-t&&(n.push(e),r.length-1===i&&n.push(t)),2===r.length&&n.push(t),t}):n=t[0];var i=e.getRandomInt(0,n.length),r=n[i];return r},makePotentialCells:function(e,t,n){for(var i=[],r=0;r<e.length;r++){var u=this.getPlayerPotentialCells(e[r].index,t,n);if(u){if("object"!==("undefined"==typeof u?"undefined":_typeof(u))||!u[0])return u;i.push(u)}}return i},getPlayerPotentialCells:function(t,n,i){for(var r=[],u=0;u<n.length;u++){var o=n[u].index,s=o*t,l=this.getAxis(s);if(l){var a=o+t,c=this.getPotentialCell(l,a),f=e.field[c.findedCell-1];if(c)if(f.ticked){if(f.tickType===e.tickType[i]){var h=this.testTick(t,!0,i);if(h){var d=e.checkWinnerCombination(l,i);if(this.testTick(t,!1),d)return{cell:t,comb:d,axis:"z"===l&&d.some(function(e){return 3===e})?l+"-45":l}}}}else r.push(c.findedCell)}}return!!r.length&&r},getPotentialCell:function(t,n){for(var i=e.axissValues[t],r=0;r<i.length;r++){var u=Object.keys(i[r])[0],o=i[r][u],s=o.some(function(e){return e===n});if(s){var l=u-n;return{propAxisSumRow:u,findedCell:l}}}return!1},testTick:function(t){var n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=arguments[2],r=t-1;return n?(e.field[r].ticked=!0,e.field[r].tickType=e.tickType[i],!0):(e.field[r].ticked=!1,e.field[r].tickType="",!1)},getAxis:function(t){for(var n in e.axiss){var i=e.axiss[n],r=i.some(function(e){return e===t});if(r)return n}return!1}}}},{key:"doRun",value:function(){var e=this;return{run:function(){"human"===e.run?this.doHuman():this.doComputer()},doHuman:function(){function t(t){var i=t.target;if("TD"===i.tagName){var r=i.id,u=this.tick(r,!0,e.tickType.human);if(u){e.fieldElement.removeEventListener("click",n);var o=e.checkWinnerCombination(!1,"human");if(o)return void e.winner(o.comb,o.axis);e.draw(),e.run="computer",this.run()}}}var n=t.bind(this);e.fieldElement.addEventListener("click",n)},doComputer:function(){if(e.count<2){var t=!1;do{var n=e.getRandomInt(0,e.fieldSize);t=this.tick(n,!0,e.tickType.computer),e.run="human",this.run()}while(t===!1)}else{var i=e.analysis()["do"]();if(i)if("number"==typeof i){i===-1&&(e.count=e.fieldSize,e.draw());var r=i-1,u=this.tick(r,!0,e.tickType[e.run]);u&&(e.draw(),e.run="human",this.run())}else{var o=i.cell-1,s=this.tick(o,!0,e.tickType[e.run]);if(s)return void e.winner(i.comb,i.axis)}}},tick:function(t,n,i){return!e.field[t].ticked&&(e.field[t].ticked=n,e.field[t].tickType=i,e.view(t,i),e.count++,!0)}}}}]),e}(),app=new App;app.init().then(function(e){app.doRun().run()});