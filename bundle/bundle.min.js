"use strict";function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _extendableBuiltin(e){function t(){var t=Reflect.construct(e,Array.from(arguments));return Object.setPrototypeOf(t,Object.getPrototypeOf(this)),t}return t.prototype=Object.create(e.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e,t}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),Game=function(){function e(){_classCallCheck(this,e),this.fieldSize=9,this.run="human",this.tickType={human:"cross",computer:"nil"},this.numberingAxes={},this.multiplyingAxes={},this.additionAxes={},this.fieldCells={},this.count=0,this.state="",this.__proto__.CssClasses_={field:"tttoe",cell:"tttoe__cell",win:"tttoe__cell--winner",hidden:"is-hidden"},this.__proto__.CssIds_={app:"game",cursor:"comp_cursor"}}return _createClass(e,[{key:"countAxesValues",value:function(){for(var e=this,t=["x","y","z"],n=this.doCells(),i=Math.sqrt(this.fieldSize),r=function(r){var s=e.doMatrix(n,i,t[r]);e.numberingAxes[t[r]]=s;var l=e.doMatrix(n,i,t[r]);e.computeCells(l),e.multiplyingAxes[t[r]]=l.reduce(function(e,t){return e.concat(t)});var o=e.doMatrix(n,i,t[r]);e.additionAxes[t[r]]=e.sumAxissRows(o),e.computeCells(o,!1),e.additionAxes[t[r]].forEach(function(e,t){return e[Object.keys(e)[0]]=o[t]})},s=0;s<t.length;s++)r(s)}},{key:"doCells",value:function(){for(var e=[],t=1;t<=this.fieldSize;t++)e.push(t);return e}},{key:"doMatrix",value:function(e,t,n){function i(n,r,s){r=r||[],n=n,s=s;for(var l=1;l<=e.length;l++)l%t===1&&s.push(l+(r.length?n--:n++));return r.push(s),1===r.length?i(t-1,r,[]):r}var r=[],s=[];if("z"===n)return i(0,r,s);"y"===n&&(e=e.slice(0).sort(function(e,n){return e%t-n%t}));for(var l=1;l<=e.length;l++)s.push(e[l-1]),l%t||(r.push(s),s=[]);return r}},{key:"computeCells",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];e.forEach(function(e,n,i){var r=[];!function s(e){e.reduce(function(e,n,i,l){return l.length>1&&r.push(t?e*n:e+n),n===l[l.length-1]&&(l.shift(),s(l)),e})}(e),i[n]=r})}},{key:"sumAxissRows",value:function(e){return e.map(function(e){var t=e.reduce(function(e,t){return e+t}),n={};return n[t]=[],n})}},{key:"makeFieldCells",value:function(){for(var e=0;e<this.fieldSize;e++)this.fieldCells[e]={ticked:!1,tickType:"",position:e+1};this.fieldCells.length=this.fieldSize}},{key:"makeView",value:function(){for(var e=this,t=document.createElement("table"),n=Math.sqrt(this.fieldSize),i=0;i<n;i++){for(var r=document.createElement("tr"),s=0;s<n;s++){var l=document.createElement("td");l.className=this.CssClasses_.cell,l.id=n*i+s;var o=document.createElement("div");o.className=this.CssClasses_.field+"__inner",l.appendChild(o),r.appendChild(l)}t.appendChild(r)}t.className=this.CssClasses_.field;var u=document.createElement("div");return u.id="comp_cursor",u.className="tttoe__computer-cursor is-hidden",new Promise(function(n,i){document.addEventListener("DOMContentLoaded",function(i){e.fieldElement=document.getElementById(e.CssIds_.app),e.fieldElement.appendChild(u),e.fieldElement.appendChild(t),n()})})}},{key:"makeMove",value:function(){"human"===this.run?this.doHuman():this.doComputer()}},{key:"doHuman",value:function(){function e(e){var n=e.target;if("DIV"===n.tagName){var i=n.closest("td").id,r=this.tick(i,this.tickType.human);if(r){this.fieldElement.removeEventListener("click",t);var s=this.checkWinnerCombination(!1,"human");s?this.displayWinner(s.comb,s.axis):(this.run="computer",this.makeMove())}}}var t=e.bind(this);"human"===this.run&&this.fieldElement.addEventListener("click",t)}},{key:"doComputer",value:function(){var e=this,t=this.analysis(),n=t.cell-1;this.computerMoveAnimation(n).then(function(i){var r=e.tick(n,e.tickType[e.run]);e.state=e.count===e.fieldSize?"draw":e.state,"win"===e.state?r&&e.displayWinner(t.comb,t.axis):"draw"===e.state?(e.count=e.fieldSize,e.draw()):r&&setTimeout(function(){e.run="human",e.makeMove()},500)})}},{key:"tick",value:function(e,t){!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return!(!this.fieldCells[e]||this.fieldCells[e].ticked)&&(this.fieldCells[e].ticked=!0,this.fieldCells[e].tickType=t,this.displayTick(e,t),this.count++,!0)}},{key:"checkWinnerCombination",value:function(e,t){function n(e){for(var t=function(t){var n=e[t],i=!1;if(r.length===n.length?i=r.every(function(e){return n.some(function(t){return e===t})}):r.length>n.length&&(i=n.every(function(e){return r.some(function(t){return e===t})})),i)return{v:n}},n=0;n<e.length;n++){var i=t(n);if("object"===("undefined"==typeof i?"undefined":_typeof(i)))return i.v}return!1}var i=this,r=Array.from(this.fieldCells).filter(function(e){return e.ticked&&e.tickType===i.tickType[t]}).map(function(e){return e.position});if(e){var s=this.numberingAxes[e];return n(s)}var l=[],o=[];for(var u in this.numberingAxes){var a=this.numberingAxes[u];o.push(n(a)),l.push(u)}var c=o.findIndex(function(e){return e.length});if(~c)return{comb:o[c],axis:this.makeRotateAxisClass(l[c],o[c])}}},{key:"analysis",value:function(){var e={};if(this.count<2){var t=!1,n=void 0;do n=this.getRandomInt(0,this.fieldSize),t=this.isTickedCell(n);while(t===!0);e.cell=n+1}else{var i=this.filterCells(),r=this.makePotentialCells(i.emptyCells,i.computerCells,"computer"),s=this.makePotentialCells(i.emptyCells,i.humanCells,"human");r.cell?(this.state="win",e=r):s.cell?e.cell=s.cell:r.length?e.cell=this.chooseRandomCell(r):s.length?e.cell=this.chooseRandomCell(s):(this.state="draw",e.cell=i.emptyCells[0]?i.emptyCells[0].position:-1)}return e}},{key:"filterCells",value:function(){var e=this,t=Array.from(this.fieldCells),n={};return n.emptyCells=t.filter(function(e){return!e.ticked}),n.humanCells=t.filter(function(t){return t.tickType===e.tickType.human}),n.computerCells=t.filter(function(t){return t.tickType===e.tickType.computer}),n}},{key:"makePotentialCells",value:function(e,t,n){for(var i=[],r=0;r<e.length;r++){var s=this.getPlayerPotentialCells(e[r].position,t,n);if(s){if("object"!==("undefined"==typeof s?"undefined":_typeof(s))||!s[0])return s;i.push(s)}}return i}},{key:"getPlayerPotentialCells",value:function(e,t,n){for(var i=[],r=0;r<t.length;r++){var s=t[r].position,l=s*e,o=this.getAxis(l);if(o){var u=s+e,a=this.getPotentialCell(o,u);if(a){var c=this.fieldCells[a-1];if(c.ticked){if(c.tickType===this.tickType[n]){var f=this.doTestTick(e,n);if(f){var h=this.checkWinnerCombination(o,n);if(this.doTestTick(e,!1,!1),h)return{cell:e,comb:h,axis:this.makeRotateAxisClass(o,h)}}}}else i.push(a)}}}return!!i.length&&i}},{key:"getPotentialCell",value:function(e,t){for(var n=this.additionAxes[e],i=0;i<n.length;i++){var r=Object.keys(n[i])[0],s=n[i][r],l=s.some(function(e){return e===t});if(l)return r-t}return!1}},{key:"isTickedCell",value:function(e){return!!this.fieldCells[e].ticked}},{key:"doTestTick",value:function(e,t){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],i=e-1;return n?(this.fieldCells[i].ticked=!0,this.fieldCells[i].tickType=this.tickType[t],!0):(this.fieldCells[i].ticked=!1,this.fieldCells[i].tickType="",!1)}},{key:"getAxis",value:function(e){for(var t in this.multiplyingAxes){var n=this.multiplyingAxes[t],i=n.some(function(t){return t===e});if(i)return t}return!1}},{key:"makeRotateAxisClass",value:function(e,t){return e="z"===e&&t.some(function(e){return 3===e})?e+"-45":e}},{key:"chooseRandomCell",value:function(e){e=e.reduce(function(e,t){return e.concat(t)});var t=new UniqueArray(e),n=t.unique(),i=this.getRandomInt(0,n.length),r=n[i];return r}},{key:"getRandomInt",value:function(e,t){return Math.floor(Math.random()*(t-e))+e}},{key:"displayTick",value:function(e,t){var n=document.createElement("div");n.className="tttoe__tick tttoe__tick--"+this.tickType[this.run],this.fieldElement.querySelectorAll("td")[e].firstElementChild.appendChild(n)}},{key:"displayWinner",value:function(e,t){for(var n=0;n<e.length;n++)this.fieldElement.querySelectorAll("td")[e[n]-1].classList.add(this.CssClasses_.win+"-"+t);console.log("Winner is: "+this.run),setTimeout(function(){window.location.reload()},2e3)}},{key:"draw",value:function(){this.count===this.fieldSize&&(setTimeout(function(){window.location.reload()},2e3),console.log("Draw!"))}},{key:"computerMoveAnimation",value:function(e){var t=this;return new Promise(function(n,i){if(e>=0){var r=document.getElementById(e),s=r.offsetWidth/2,l=document.getElementById(t.CssIds_.cursor),o=r.offsetTop+s-l.offsetTop-l.offsetHeight+"px",u=r.offsetLeft+s-l.offsetLeft+"px";l.classList.remove(t.CssClasses_.hidden),l.style.top=o,l.style.left=u,setTimeout(function(){l.classList.add(t.CssClasses_.hidden),l.style.top="",l.style.left="",n()},1e3)}else n()})}},{key:"init",value:function(){var e=this;return this.countAxesValues(),this.makeFieldCells(),new Promise(function(t,n){e.makeView().then(function(e){return t()})})}}]),e}(),UniqueArray=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return _inherits(t,e),_createClass(t,[{key:"unique",value:function n(){this[0].sort(function(e,t){return e-t});var n=[];if(this[0].length>1)this[0].reduce(function(e,t,i,r){return e-t?(n.push(e),r[r.length-1]===r[i]&&n.push(t)):2===r.length&&n.push(t),t});else{if(!this[0].length)throw new Error("The array does not have a suitable length!");n=this[0]}return n}}]),t}(_extendableBuiltin(Array)),game=new Game;game.init().then(function(e){return game.makeMove()});